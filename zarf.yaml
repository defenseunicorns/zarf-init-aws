kind: ZarfInitConfig
metadata:
  name: init-aws
  description: "Zarf Init Package that uses ECR as an external Zarf registry"
  url: https://github.com/defenseunicorns/zarf-init-aws

constants:
  - name: PEPR_IMAGE
    value: "###ZARF_PKG_TMPL_PEPR_IMAGE###"
  - name: PEPR_IMAGE_TAG
    value: "###ZARF_PKG_TMPL_PEPR_IMAGE_TAG###"

variables:
  - name: REGISTRY_TYPE
    description: "Specify whether you want to use a private or public ECR registry"
    prompt: true

  - name: AWS_REGION
    description: "The AWS region the ECR registry is located in"
    prompt: true

  - name: ECR_ROLE_ARN
    description: "The ARN of an IAM role to give Pepr necessary permissions to list and create ECR repositories, as well as fetch ECR authorization tokens."
    prompt: true

components:
  - name: ecr-bootstrap
    description: "Bootstrap the deployment by creating an ECR repository for the Pepr controller image"
    required: true
    files:
      - source: hack/ecr.sh
        target: hack/ecr.sh
        executable: true
    actions:
      onDeploy:
        after:
          - cmd: ./hack/ecr.sh
            description: "Create ECR repository for the Pepr controller image"

  - name: ecr-module
    description: "Pepr module that creates ECR repos for images during package deployments, and updates image pull secrets with new ECR tokens."
    required: true
    manifests:
      - name: module
        namespace: pepr-system
        kustomizations:
          - manifests
    images:
      - "###ZARF_PKG_TMPL_PEPR_IMAGE_DOMAIN###/###ZARF_PKG_TMPL_PEPR_IMAGE###:###ZARF_PKG_TMPL_PEPR_IMAGE_TAG###"

  - name: zarf-agent
    required: true
    import:
      url: oci://ghcr.io/defenseunicorns/packages/init:v0.31.3-skeleton
      name: zarf-agent

  # (Optional) Adds a git server to the cluster
  - name: git-server
    import:
      url: oci://ghcr.io/defenseunicorns/packages/init:v0.31.3-skeleton
      name: git-server
